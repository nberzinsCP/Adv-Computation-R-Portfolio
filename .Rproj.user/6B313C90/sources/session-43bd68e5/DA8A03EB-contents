---
title: "Lab 4: Avocado Prices"
author: "Your Name"
format: 
  html:
    self-contained: true
    code-tools: true
    toc: true
editor: source
execute: 
  error: true
  echo: fenced
  message: false
  warning: false
---

::: callout-tip
I advise you to focus particularly on:

-   Setting chunk options carefully.

-   Making sure you don't print out more output than you need to.

-   Making your code readable and nicely formatted.

-   Thinking through your desired result **before** writing any code.
:::

[Download starter .qmd file](lab4-avocado-prices.qmd)

[Download data -- `avocado-updated-2020.csv`](avocado-updated-2020.csv)

## Data Set-up

In this lab we're going to be looking at avocado prices.

The data set comes to us from Kaggle and represents weekly retail scan data. A description of the data can be found [here.](https://www.kaggle.com/datasets/timmate/avocado-prices-2020).

::: callout-note
### Description of columns
The data set website is an updated data set from the original published in 2018. Please refer to the [main page](https://www.kaggle.com/datasets/neuromusic/avocado-prices) of the original data set for a description of the columns.
:::

**0. Import the data and declare your package dependencies.**

```{r}
library(tidyr)
library(dplyr)
library(here)
library(ggplot2)
library(readxl)
```


**1. Briefly describe the data set. What information does it contain?**
Date, total number of avocados sold (including all PLU codes), region of interest where avocados were sold, type of avocado, etc. 

```{r}
avocados <- read.csv("avocado-updated-2020.csv")
summary(avocados)
```


**2. Clean the data in any way you see fit.**

::: callout-warning
In particular, look carefully at the `geography` variable. Notice that the category `"Los Angeles"` is contained in `"California"`, which is contained in `"West"`, which is contained in `"Total U.S."`. Think about how you want to handle this issue in your analysis.

How many distinct geographical regions are there? Can you categorize them into different types of geographical regions (e.g. major regions, metro regions, etc.)? Will you create a new variable for this? A new data set for each?

You may also want to consider renaming variables so they make sense intuitively. For example, what does `4046` mean in terms of the size of avocados?
:::

```{r}

states <- c("Alabama", "Alaska", "American Samoa", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "District of Columbia", "Florida", "Georgia", "Guam", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Minor Outlying Islands", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Northern Mariana Islands", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Puerto Rico", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "U.S. Virgin Islands", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming")


#Making the horribly crafted regions column to make more sense
avocados_clean <- avocados|>
  mutate(region = if_else(geography %in% c("Great Lakes", "Midsouth", "Northeast", "Plains", "Southeast", "South Central", "West"), TRUE, FALSE)) |>
  mutate(state = if_else(geography %in% states, TRUE, FALSE)) |>
  mutate(AmericaTotal = if_else(geography == "Total U.S.", TRUE, FALSE)) |>
  mutate(metropolitan = if_else(region == FALSE & state == FALSE & AmericaTotal == FALSE, TRUE, FALSE))

#Renaming the Horribly Named Columns, which were horribly crafted by the horrible company Hass
avocados_clean <- avocados_clean |>
  rename(
    Small_Medium = X4046, 
    Large = X4225,
    ExLarge = X4770
  ) #referenced from Statology

avocados_clean <- avocados_clean |>
  mutate(volume_total = Small_Medium + Large + ExLarge) |>
  select(-total_volume) #referenced from Statology

names(avocados_clean)
```

Referenced this discussion post on how to clean the data set: https://www.kaggle.com/datasets/neuromusic/avocado-prices/discussion/340388 

------------------------------------------------------------------------

# Exercises

::: callout-note
Use your cleaned data set to answer these next three questions. In other words, `avocado_clean` is your starting "main subject" for each of question.
:::

**3. Which major geographical region sold the most total organic, small Hass avocados in 2017?**

```{r}
avocados_clean |>
  filter(type == "organic" & region) |>
  group_by(geography) |>
  summarize(Small_Medium = sum(Small_Medium))
  
```

The West sold the most small, organic avocados of the 7 regions. 

**4. Use the `separate()` function to split the `date` variable into month, day, and year. In which month is the highest average volume of avocado sales?**

```{r}
avocados_clean <- avocados_clean |>
  separate(col = date, c("Month", "Day", "Year"), sep = "/")

```


**5. Which metro area geographical regions sold the most total avocados? Plot side-by-side box-plots of the total volume for only the five metro geographical regions with the highest averages for the `total_volume` variable.**

```{r}
#Checking top 5
avocado_top5 <- avocados_clean |>
  filter(metropolitan) |>
  group_by(geography) |>
  summarize(volume_total = mean(volume_total)) |>
  slice_max(volume_total, n = 5)

avocado_top5

#avocado_metro <- avocados_clean |>
#  filter(metropolitan)

#metro_semi <- avocado_metro |>
#  semi_join(avocado_top5, by = c("geography" = "geography"))
  
#ggplot(data = metro_semi) +
# geom_boxplot(mapping = aes(x = geography, y = volume_total))

```


::: callout-tip
You still want each individual observations in your plot, but you will need to somehow identify the average for each metro geographical region.

*Hint:* One way you might approach this is by creating a new summarized data set and using filtering joins -- `semi_join()`.
:::

------------------------------------------------------------------------

# Pivoting

The following four California geographical regions are in this data set: `"Los Angeles"`, `"San Diego"`, `"Sacramento"`, and `"San Francisco"`. 

**6. From your cleaned data set, create a data set with only these California regions and answer the following questions about these California regions only.**

```{r}

calicados <- avocados_clean |>
  filter(geography == c("Los Angeles", "San Diego", "Sacramento", "San Francisco"))

```


**7. In which California regions is the price of organic versus conventional avocados most different? Support your answer with a few summary statistics AND a visualization.**

::: callout-tip
You do not have to, but you may want to transform your data. Sketch out what you want the data set to look like before you begin to code! Come up with a game plan to answer this question.
:::


```{r}

#expand on sum stats
calicados |>
  group_by(geography, type) |>
  summarise(average_price = mean(average_price)) |>
  pivot_wider(names_from = type, values_from = average_price) |>
  mutate(price_diff = organic - conventional) |>
  ggplot(mapping = aes(x = price_diff, y = geography)) +
  geom_col() +
  coord_flip()
```


**8. The following plot shows, for all four California regions, the proportion of the average Hass avocado sales that are small, large, or extra large; conventional vs. organic. Recreate the plot; you do not have to replicate the exact finishing touches - e.g., color, theme - but your plot should resemble the content of this plot.**

::: callout-tip
This will require transforming of your data! Sketch out what you want the data set to look like before you begin to code! I recommend starting with your California data set you create in Q6. 
:::

```{r Altering Size Variable}
calicados <- calicados |>
  pivot_longer(cols = c("Small_Medium", "Large", "ExLarge"),
               names_to = "Size",
               values_to = "Quantity_Sold")
```



```{r}
my_colors <- c("#F8B195", "#C06C84", "#355C7D") # taken from https://stackoverflow.com/questions/58470258/ggplot2-changing-fill-colors-of-geom-col as well as lines 219 and 220


calicados |>
  ggplot(mapping = aes(x = geography, y = Quantity_Sold, fill = Size)) +
  geom_col(position = 'Fill') +
  scale_color_manual(values = my_colors) + 
  scale_fill_manual(values = my_colors) +
  facet_grid(~type) +
  coord_flip() +
  labs(title = "Proportion of Mean Avocados Sold", x = "Region of California", y = NULL) +
  scale_y_continuous(labels = scales::percent)

```


![Plot to recreate](https://github.com/earobinson95/stat331-calpoly/blob/master/lab-assignments/lab4/ca-avocado-size-proportions.png?raw=true)

------------------------------------------------------------------------

# Challenge: Avocado Toast Ate My Mortgage

A joke in the media is that Millennials can't afford houses, because they spend all their money buying avocado toast. Let's use this data set to address that claim.

> Find or make a data set with house prices for these four California regions. Join this data set with your California avocado data set. 
>
> Use your new joined data set to make an argument about the relationship between house prices and avocado prices/sales.
>
> Support your argument with a plot.


```{r Importing Data}
cal_housing <- read_xlsx("County Sales & Price Statistics (Public).xlsx",
                         sheet = "SFH Sales & Price",
                         skip = 5,
                         n_max = 66)

```
```{r Data Cleaning}
cal_housing_clean <- cal_housing |>
  select(-c("...4", "...6"))

cal_housing_clean <- cal_housing_clean |>
  filter(`State/Region/County` == "Los Angeles" |
           `State/Region/County` == "San Diego"  |
           `State/Region/County` == "San Francisco" |
           `State/Region/County` == "Sacramento" ) |>
  rename(
    Dec22 = as.character(44896), 
    Nov22 = as.character(44868),
    Dec21 = as.character(44531),
    geography = `State/Region/County`
  ) |>
  mutate(Median_Home_Price = ((Dec22 + Dec21 + Nov22)/3)) |>
  select(c("geography","Median_Home_Price"))
  
  
```

```{r}
homes_cados <- full_join(calicados, cal_housing_clean) |>
  select(c("geography", "average_price", "Median_Home_Price"))

cor(homes_cados$average_price, homes_cados$Median_Home_Price)

homes_cados |> 
  ggplot(mapping = aes(x = Median_Home_Price, y = average_price, color = geography)) +
  geom_point()
```

There appears to be a weak, negative correlation (-.279) between the median home price of California homes and average avocado prices in these four cities. 